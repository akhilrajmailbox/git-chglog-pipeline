name: Sample Build

on:
  release:
    types:
      - "created"

env:
  env_var: ${{ vars.ENV_CONTEXT_VAR }}
  CHANGELOG_BR: main

jobs:
  chglog:
    permissions:
      contents: 'write'
      pull-requests: 'write'
      id-token: 'write'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.CHGLOG_GITHUB_TOKEN }}
          persist-credentials: true

      - name: Check chglog config
        id: chglog_config
        shell: bash
        run: |
          if test -d ".chglog" ; then
            if test -f ".chglog/config.yml" ; then
              echo "present=true" >> ${GITHUB_OUTPUT}
            fi
          fi

      - name: Install git-chglog and generate CHANGELOG
        if: ${{ steps.chglog_config.outputs.present == 'true' }}
        shell: bash
        run: |
          curl -sLfO https://github.com/git-chglog/git-chglog/releases/download/v0.15.4/git-chglog_0.15.4_linux_amd64.tar.gz
          tar -zxvf git-chglog_0.15.4_linux_amd64.tar.gz
          chmod +x git-chglog
          sudo mv git-chglog /usr/local/bin/
          TAG_NAME=${GITHUB_REF_NAME}
          /usr/local/bin/git-chglog --config .chglog/config.yml --output CHANGELOG.md

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.CHGLOG_GITHUB_TOKEN }}
          commit-message: 'devops: Update CHANGELOG for ${{ github.event.release.tag_name }} - [skip ci]'
          title: 'CHANGELOG for ${{ github.event.release.tag_name }}'
          committer: GitHub Action <action@github.com>
          author: GitHub Action <action@github.com>
          body: >
            This PR is auto-generated by
            [release pipeline](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          base: ${{ env.CHANGELOG_BR }}
          branch: cicd-changelog
          delete-branch: true
          add-paths: CHANGELOG.md
          # reviewers: akhilrajmailbox

      # - name: Commit CHANGELOG
      #   if: ${{ steps.chglog_config.outputs.present == 'true' }}
      #   shell: bash
      #   run: |
      #     git fetch
      #     git switch -c ${{ env.CHANGELOG_BR }} origin/${{ env.CHANGELOG_BR }}
      #     git config --local user.email "action@github.com"
      #     git config --local user.name "GitHub Action"
      #     git add CHANGELOG.md
      #     git commit -m "Update CHANGELOG for ${GITHUB_REF#refs/tags/}  - [skip ci]"
      #     git push origin ${{ env.CHANGELOG_BR }}